<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Secure View</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #secureTable { table-layout: auto; }
    #secureTable th,
    #secureTable td {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 20rem;
    }
    #secureTable thead th {
      background: #1e3a5f;
      color: #fff;
      font-weight: 700;
      font-size: 0.8125rem;
      padding: 0.5rem 0.75rem;
      border: 1px solid #1e3a5f;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    #secureTable tbody td {
      padding: 0.5rem 0.75rem;
      border: 1px solid #e2e8f0;
      font-size: 0.8125rem;
      color: #334155;
    }
    #secureTable tbody tr:nth-child(even) td {
      background: #f8fafc;
    }
    #secureTable tbody tr:hover td {
      background: #f1f5f9;
    }
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800">
  <header class="bg-[#1e3a5f] text-white shadow-md">
    <div class="max-w-6xl mx-auto px-4 py-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
      <div>
        <h1 id="secureTitle" class="text-xl sm:text-2xl font-semibold tracking-tight">
          Secure View
        </h1>
        <p class="mt-1 text-xs sm:text-sm text-white/80"></p>
      </div>
      <div>
        <button
          id="logoutBtn"
          class="rounded-lg bg-white/20 hover:bg-white/30 text-white text-sm font-semibold px-4 py-2 transition"
        >
          Logout to main page
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 sm:p-6">
      <div id="secureStatus" class="text-sm text-slate-600 mb-3">
        Loading secure data...
      </div>
      <div class="overflow-auto max-h-[75vh]">
        <div class="min-w-max inline-block">
          <table id="secureTable" class="hidden border-collapse">
            <thead id="secureThead"></thead>
            <tbody id="secureTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script>
    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name) || "";
    }

    function escapeHtml(str) {
      const div = document.createElement("div");
      div.textContent = str;
      return div.innerHTML;
    }

    async function loadSecureTab() {
      const sheet = getQueryParam("sheet").trim();
      const titleEl = document.getElementById("secureTitle");
      const statusEl = document.getElementById("secureStatus");
      const thead = document.getElementById("secureThead");
      const tbody = document.getElementById("secureTbody");
      const table = document.getElementById("secureTable");

      if (!sheet) {
        statusEl.textContent = "Missing sheet/tab name in URL.";
        return;
      }

      document.title = sheet;
      titleEl.textContent = sheet;

      try {
        const params = new URLSearchParams();
        params.set("sheet", sheet);
        const response = await fetch("/api/tab?" + params.toString());
        const data = await response.json();

        if (!response.ok) {
          statusEl.textContent = data.error || "Failed to load secure data.";
          return;
        }

        const header = data.header || [];
        const rows = data.rows || [];

        let headerHtml = "<tr>";
        header.forEach((h) => {
          const text = (h !== undefined && h !== null) ? String(h) : "";
          headerHtml += `<th scope="col">${escapeHtml(text)}</th>`;
        });
        headerHtml += "</tr>";
        thead.innerHTML = headerHtml;

        let bodyHtml = "";
        rows.forEach((row) => {
          bodyHtml += "<tr>";
          header.forEach((_, idx) => {
            const cell = row[idx] !== undefined && row[idx] !== null ? String(row[idx]) : "";
            bodyHtml += `<td>${escapeHtml(cell)}</td>`;
          });
          bodyHtml += "</tr>";
        });
        tbody.innerHTML = bodyHtml;

        table.classList.remove("hidden");
        statusEl.textContent = "";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error contacting secure backend.";
      }
    }

    const logoutBtn = document.getElementById("logoutBtn");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", () => {
        // If opened from the main tracking page, refresh it and then close this tab/window
        try {
          if (window.opener && !window.opener.closed) {
            // Refresh main page so any session state is cleared/updated
            window.opener.location.reload();
            window.opener.focus();
          }
        } catch (e) {
          // ignore cross-origin issues
        }
        window.close();
      });
    }

    loadSecureTab();
  </script>
</body>
</html>
